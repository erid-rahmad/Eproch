<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd
                        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

    
    <!--
        Added the entity MRfqView.
    -->
    <changeSet id="20210815051300-view-1" author="ricky-k">
        <createView
            replaceIfExists="true"  
            viewName="m_rfq_view">
select row_number () over (order by rfq.id) id, rfq.id quotation_id, rfq.document_no, rfq.title, rfq.date_required, rfq.selection_method, 
case when rfq.selection_method = 'P' then 1 when selection_method ='T' then 1 else coalesce(q1.joined_vendor_count,0) end joined_vendor_count from m_rfq rfq 
left join (
select rfq.id, count(mrs.id) joined_vendor_count from m_rfq rfq 
left join m_rfq_submission mrs on mrs.quotation_id = rfq.id where mrs.document_status = 'SMT'
group by rfq.id order by rfq.id ) q1 on q1.id = rfq.id
        </createView>
    </changeSet>

</databaseChangeLog>
